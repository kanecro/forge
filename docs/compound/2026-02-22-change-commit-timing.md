---
category: pattern
stack: general
severity: important
date: 2026-02-22
tags: commit-timing, sync, review-gap, yagni, config-change, workflow
artifact-targets: commands, agents, spec-template
---

# コミットタイミング変更: 同期漏れ再発とYAGNI/セキュリティ境界の教訓

## 何が起きたか

Forge ワークフローのコミットタイミングをタスク単位の自動コミットからユーザーの明示的指示に変更した。13タスク・12ファイルの変更を実施し、仕様準拠率 13/13 で完了。しかし以下の問題が発生した:

1. **プロジェクト/グローバル同期漏れ（2回目）**: `~/.claude/` 配下の11ファイルを変更したが、リポジトリ内の対応ファイル（`agents/`, `commands/`, `reference/`）への同期が漏れた。ユーザーの明示的な指示で初めて同期された。
2. **YAGNI とセキュリティの衝突**: proposal.md で `.gitignore` への除外追加を「YAGNI」としてスコープ外にしたが、security-sentinel が P2 として指摘し、結局修正が必要になった。
3. **概念変更の残存**: `git log --oneline` → `git diff --stat` の変更が implement.md では反映されたが、CLAUDE.md と implement-orchestrator.md で旧記述が残存した。

## なぜ起きたか

1. **同期ステップがワークフローに組み込まれていない**: `/implement` コマンドの完了サマリーにリポジトリ同期の確認ステップがない。前回（2026-02-18）と同一の根本原因。
2. **YAGNI の適用範囲が曖昧**: セキュリティ防御策（`.gitignore`）を「YAGNI」で除外したが、ソフトルールのみの除外はリスクが残る。YAGNI はセキュリティ防御策には適用すべきでない。
3. **仕様のタスクスコープが狭すぎた**: Task 11 の「やること」に「Main Agent の責務」セクションの変更が含まれていなかった。概念全体（コミット → diff）を横断的に検索する検証ステップが不足していた。

## どう解決したか

1. 同期漏れ: ユーザー指示でリポジトリ内ファイルへのコピーを実施
2. YAGNI 衝突: レビューで検出し、`.gitignore` に除外パターンを追加
3. 残存チェック: レビューで検出し、CLAUDE.md と implement-orchestrator.md を修正

## 教訓

1. **プロジェクト/グローバル同期は自動化が必要（2回目の発生で確定）**: 手動同期は確実に漏れる。`/implement` の完了ステップに同期確認を組み込むか、フックで自動化する必要がある。
2. **YAGNI はセキュリティ防御策に適用しない**: 「今は不要」でも、防御的セキュリティ対策（`.gitignore`, バリデーション等）は初回から実装すべき。spec-validator のチェックリストに「セキュリティ関連を YAGNI で除外していないか」を追加すべき。
3. **概念変更は横断検索で検証する**: 特定の概念（例: `git log` → `git diff`）を変更する場合、対象ファイルだけでなく全ファイルを Grep して残存がないか確認する検証ステップが必要。

## 防止策と更新提案

### コマンドフロー更新
- [ ] `/implement` の完了ステップに「リポジトリ内ファイルと `~/.claude/` の同期確認」を追加（2回目の発生、閾値: 中程度）

### 仕様テンプレート更新
- [ ] spec-validator のチェックリストに「セキュリティ防御策を YAGNI / Out of Scope で除外していないか」を追加（初回発生、閾値: 軽微→記録のみ）

### エージェント定義更新
- [ ] spec-compliance-reviewer の検証項目に「概念変更（用語・コマンド置換）の横断 Grep 検証」を追加（初回発生、閾値: 軽微→記録のみ）
