# Lattice Core Rules

Lattice ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ãƒ«ãƒ¼ãƒ«ã€‚ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é©ç”¨ã•ã‚Œã‚‹åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‚

---

## Rule Priority System

**ğŸ”´ CRITICAL**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‡ãƒ¼ã‚¿å®‰å…¨æ€§ã€æœ¬ç•ªå½±éŸ¿ - çµ¶å¯¾ã«å¦¥å”ã—ãªã„
**ğŸŸ¡ IMPORTANT**: å“è³ªã€ä¿å®ˆæ€§ã€å°‚é–€æ€§ - å¼·ãæ¨å¥¨
**ğŸŸ¢ RECOMMENDED**: æœ€é©åŒ–ã€ã‚¹ã‚¿ã‚¤ãƒ«ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ - å®Ÿç”¨çš„ãªæ™‚ã«é©ç”¨

---

## Phase Discipline

**Priority**: ğŸ”´ **Triggers**: ã™ã¹ã¦ã®é–‹ç™ºä½œæ¥­

### Phase Workflow

```
init â†’ spec â†’ design â†’ implement â†’ integrate â†’ complete
```

### Phase Rules

- **ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é©ã—ãŸä½œæ¥­ã®ã¿å®Ÿè¡Œ**
  - spec ãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã‚’å§‹ã‚ãªã„
  - design ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãªã„
  - implement ãƒ•ã‚§ãƒ¼ã‚ºã§ä»•æ§˜ã‚’å¤‰æ›´ã—ãªã„

- **ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»å‰ã«æ¤œè¨¼å¿…é ˆ**
  - `/verify` ã‚³ãƒãƒ³ãƒ‰ã§æ¤œè¨¼ã‚’å®Ÿè¡Œ
  - ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒé€šéã—ã¦ã‹ã‚‰é·ç§»

- **é•åæ¤œå‡ºæ™‚ã®å¯¾å¿œ**
  1. ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Œäº†ï¼ˆæ¨å¥¨ï¼‰
  2. ä½œæ¥­ã‚’ãƒ•ã‚§ãƒ¼ã‚ºã«é©ã—ãŸå½¢ã«èª¿æ•´
  3. å¼·åˆ¶é€²è¡Œï¼ˆéæ¨å¥¨ï¼‰

âœ… **Right**: spec ãƒ•ã‚§ãƒ¼ã‚ºã§ä»•æ§˜æ›¸ã‚’æ›¸ã â†’ design ãƒ•ã‚§ãƒ¼ã‚ºã§è¨­è¨ˆã™ã‚‹ â†’ implement ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã
âŒ **Wrong**: spec ãƒ•ã‚§ãƒ¼ã‚ºã§ã„ããªã‚Šã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå§‹ã‚ã‚‹

---

## Escalation Rules

**Priority**: ğŸ”´ **Triggers**: åˆ¤æ–­ãŒå¿…è¦ãªå ´é¢

### Always Autonomous (è‡ªå¾‹åˆ¤æ–­OK)

- ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€lint ä¿®æ­£
- ãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»ä¿®æ­£
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°
- æ˜ã‚‰ã‹ãªãƒã‚°ä¿®æ­£

### Always Escalate (è¦ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®å¤‰æ›´ï¼ˆèªè¨¼ã€èªå¯ã€æš—å·åŒ–ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´
- æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é–¢é€£
- ä¸å¯é€†ãªå¤‰æ›´

### Confidence-Based Decision

| Score | Action |
|-------|--------|
| 0.9-1.0 | è‡ªå¾‹åˆ¤æ–­ã§é€²è¡Œ |
| 0.7-0.9 | ãƒ­ã‚°è¨˜éŒ²ã—ã¦é€²è¡Œ |
| 0.5-0.7 | å½±éŸ¿å¤§ãªã‚‰è¦ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| < 0.5 | å¿…ãšã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

âœ… **Right**: ä¸æ˜ç¢ºãªè¦ä»¶ â†’ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â†’ ç¢ºèªå¾Œã«å®Ÿè£…
âŒ **Wrong**: ä¸æ˜ç¢ºãªè¦ä»¶ â†’ æ¨æ¸¬ã§å®Ÿè£…

---

## Checkpoint Discipline

**Priority**: ğŸŸ¡ **Triggers**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### When to Checkpoint

| Situation | Action |
|-----------|--------|
| ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»å®Œäº† | å¿…é ˆ |
| ãƒªã‚¹ã‚¯ã®ã‚ã‚‹æ“ä½œå‰ | å¿…é ˆ |
| é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ (> 2h) | æ¨å¥¨ |
| ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåœ§ç¸®å‰ | è‡ªå‹• |
| é‡è¦ãªãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å¾Œ | æ¨å¥¨ |
| ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è§£æ±ºå¾Œ | æ¨å¥¨ |

### Checkpoint Contents

```yaml
checkpoint:
  phase: current_phase
  active_tasks: [task_list]
  recent_patterns: [pattern_ids]
  blockers: [blocker_list]
  open_questions: [questions]
  working_files: [file_list]
  git_state: {branch, uncommitted}
```

âœ… **Right**: ãƒªã‚¹ã‚­ãƒ¼ãªæ“ä½œå‰ã« `/checkpoint` ã‚’å®Ÿè¡Œ
âŒ **Wrong**: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãªã—ã§å¤§ããªå¤‰æ›´ã‚’å®Ÿè¡Œ

---

## Pattern Learning

**Priority**: ğŸŸ¢ **Triggers**: ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç™ºè¦‹ãƒ»é©ç”¨

### Pattern Recording

- æˆåŠŸã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ `log_pattern` ã§è¨˜éŒ²
- åˆ¤æ–­ã‚’ `log_decision` ã§è¨˜éŒ²
- ä¿¡é ¼åº¦ã‚’è¨¼æ‹ ã«åŸºã¥ã„ã¦æ›´æ–°

### Pattern Evolution

```
è¦³å¯Ÿ â†’ ãƒ‘ã‚¿ãƒ¼ãƒ³è¨˜éŒ² â†’ è¨¼æ‹ è“„ç© â†’ ä¿¡é ¼åº¦å‘ä¸Š â†’ ãƒãƒªã‚·ãƒ¼è’¸ç•™
```

### Distillation Criteria

| Criteria | Threshold |
|----------|-----------|
| æœ€å°ä¿¡é ¼åº¦ | 0.7 |
| æœ€å°è¨¼æ‹ æ•° | 3 |
| ã‚«ãƒ†ã‚´ãƒªä¸€è‡´ | å¿…é ˆ |

âœ… **Right**: ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜éŒ² â†’ è¤‡æ•°å›ç¢ºèª â†’ ãƒãƒªã‚·ãƒ¼ã«æ˜‡æ ¼
âŒ **Wrong**: ä¸€åº¦ãã‚Šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã™ãã«ãƒãƒªã‚·ãƒ¼åŒ–

---

## Verification Gates

**Priority**: ğŸŸ¡ **Triggers**: ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã€ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»

### Verification Levels

| Level | Checks | Use When |
|-------|--------|----------|
| Quick | Lint | å°ã•ãªå¤‰æ›´ |
| Standard | Lint + TypeCheck | é€šå¸¸ã®å¤‰æ›´ |
| Full | Lint + TypeCheck + Tests + Coverage + Security | ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»å‰ |

### Before Commit

```bash
# æœ€ä½é™ã®æ¤œè¨¼
/verify quick

# æ¨å¥¨
/verify standard
```

### Before Phase Advance

```bash
# å¿…é ˆ
/verify full
```

âœ… **Right**: æ¤œè¨¼é€šé â†’ ã‚³ãƒŸãƒƒãƒˆ â†’ ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»
âŒ **Wrong**: æ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ— â†’ ç›´æ¥ã‚³ãƒŸãƒƒãƒˆ

---

## Knowledge Auto-Loading

**Priority**: ğŸŸ¢ **Triggers**: ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º

### File Pattern Rules

| Pattern | Load |
|---------|------|
| `*.test.*` | domains/testing.md |
| `auth/*` | decisions/auth-patterns.md, anti-patterns/security-pitfalls.md |
| `api/*` | decisions/api-design.md, anti-patterns/common-mistakes.md |

### Keyword Rules

| Keywords | Load |
|----------|------|
| security, auth, login | auth-patterns.md, security-pitfalls.md |
| performance, slow, optimize | performance-issues.md |
| test, testing, coverage | domains/testing.md |

### Always Load

- policies/escalation-rules.md

---

## Git Workflow

**Priority**: ğŸ”´ **Triggers**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ“ä½œ

### Branch Rules

```
main
â”œâ”€â”€ feature/<feature-name>
â”œâ”€â”€ fix/<bug-name>
â””â”€â”€ refactor/<target>
```

### Commit Rules

**Format**: `<type>(<scope>): <description in Japanese>`

- æ„å‘³ã®ã‚ã‚‹ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- å°ã•ãªå˜ä½ã§ã‚³ãƒŸãƒƒãƒˆ
- `main` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆç¦æ­¢

### Pre-Commit Checklist

1. [ ] `/verify standard` ãŒé€šé
2. [ ] å¤‰æ›´å†…å®¹ã‚’ç¢ºèª (`git diff`)
3. [ ] ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
4. [ ] é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

âœ… **Right**: feature ãƒ–ãƒ©ãƒ³ãƒã§ä½œæ¥­ â†’ æ¤œè¨¼ â†’ PR
âŒ **Wrong**: main ãƒ–ãƒ©ãƒ³ãƒã§ç›´æ¥ä½œæ¥­

---

## Tool Optimization

**Priority**: ğŸŸ¢ **Triggers**: è¤‡æ•°ãƒ„ãƒ¼ãƒ«æ“ä½œ

### MCP Tool Priority

1. **Lattice MCP Tools** - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»åˆ¤æ–­ãƒ»ãƒãƒªã‚·ãƒ¼ç®¡ç†
2. **Native Tools** - ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã€æ¤œç´¢
3. **Bash** - ã‚·ã‚¹ãƒ†ãƒ æ“ä½œï¼ˆæœ€å°é™ï¼‰

### Parallel Execution

- ç‹¬ç«‹ã—ãŸæ“ä½œã¯ä¸¦åˆ—å®Ÿè¡Œ
- ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã®ã¿é †æ¬¡å®Ÿè¡Œ

### Batch Operations

- è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›† â†’ MultiEdit
- è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ â†’ ä¸¦åˆ— Read

---

## Error Handling

**Priority**: ğŸŸ¡ **Triggers**: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚

### Investigation First

- æ ¹æœ¬åŸå› ã‚’èª¿æŸ»ã—ã¦ã‹ã‚‰å¯¾å‡¦
- ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€šéã•ã›ãªã„
- æ¤œè¨¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ãªã„

### Recovery Pattern

```
1. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèª
2. æ ¹æœ¬åŸå› ã‚’ç‰¹å®š
3. ä¿®æ­£ã‚’å®Ÿæ–½
4. æ¤œè¨¼ã‚’é€šé
5. ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è¨˜éŒ²ï¼ˆå†ç™ºé˜²æ­¢ï¼‰
```

âœ… **Right**: ã‚¨ãƒ©ãƒ¼èª¿æŸ» â†’ åŸå› ç‰¹å®š â†’ é©åˆ‡ãªä¿®æ­£
âŒ **Wrong**: ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦– â†’ ã¨ã‚Šã‚ãˆãšå‹•ãã‚ˆã†ã«ä¿®æ­£

---

## Quick Decision Tree

```
ä½œæ¥­é–‹å§‹
  â†“
ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é©ã—ã¦ã„ã‚‹ï¼Ÿ
  NO â†’ ãƒ•ã‚§ãƒ¼ã‚ºã‚’é€²ã‚ã‚‹ã‹ä½œæ¥­ã‚’èª¿æ•´
  YES â†“

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/ãƒ‡ãƒ¼ã‚¿/ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é–¢ä¿‚ï¼Ÿ
  YES â†’ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  NO â†“

ä¿¡é ¼åº¦ >= 0.7ï¼Ÿ
  NO â†’ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  YES â†“

å¯é€†çš„ãªå¤‰æ›´ï¼Ÿ
  NO â†’ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  YES â†’ ãƒ­ã‚°è¨˜éŒ²ã—ã¦é€²è¡Œ
```

---

_Lattice Rules: ãƒ•ã‚§ãƒ¼ã‚ºè¦å¾‹ Ã— ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤æ–­ Ã— ç¶™ç¶šå­¦ç¿’_
