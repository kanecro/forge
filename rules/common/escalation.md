# エスカレーションポリシー

## 判断フロー

1. このルールで該当するカテゴリがあるか確認
2. 「必須エスカレーション」に該当 → 必ず `AskUserQuestion` で確認
3. 「状況依存エスカレーション」に該当 → 状況を評価し、判断が困難なら `AskUserQuestion`
4. いずれにも該当しない → 自律判断で続行

## 必須エスカレーション

以下に該当する場合は、必ず `AskUserQuestion` でユーザーに確認する：

- **セキュリティ**: 認証・認可ロジックの設計・変更、暗号化方式の選択、PII（個人情報）の処理方法
- **データ**: DBスキーマ変更、マイグレーション戦略、データ整合性に影響する変更
- **アーキテクチャ**: 新サービス・新モジュールの追加、破壊的API変更、レイヤー構成の変更
- **本番環境**: デプロイ設定、環境変数の変更、ロールバック手順

## 状況依存エスカレーション

以下に該当する場合は、自信を持って判断できないなら `AskUserQuestion` でユーザーに確認する：

- **仕様の曖昧性**: デルタスペックの記述が不明確、または複数の解釈が可能
- **リサーチ結果の矛盾**: 複数のリサーチエージェントが矛盾する推奨を返した
- **設計の選択肢**: 技術的に同等な複数のアプローチが存在する
- **レビュー指摘の矛盾**: 複数のレビュアーが矛盾する指摘を出した
- **P1指摘の影響範囲**: レビューのP1指摘がアーキテクチャ変更を必要とする
- **スコープ判断**: 仕様に明示されていない関連変更が必要になった

## 自律判断OK

以下は確認不要で自律的に判断してよい：

- コードフォーマット、lint修正
- ローカル変数のリネーム
- 明らかなバグ修正（null例外、off-by-one）
- 自モジュール内のリファクタリング
- P3レビュー指摘の対応
- テストコードの追加・修正（プロダクションコードへの影響なし）

## AskUserQuestion の形式

エスカレーション時は以下の構造で質問する：

- **状況**: 何をしている最中か（フェーズ、タスク名）
- **問題**: なぜ判断が必要か（具体的なトリガー）
- **選択肢**: 可能な選択肢をリストアップ（A/B/C方式）
- **推奨**: エージェントとしての推奨案（理由付き）
