# Spec Interpretation: Task 3-3 /review にリスクベースのレビュー深度調整を追加

## 対象要件
- Requirement: REQ-013
  - **仕様の記述**: `/review` コマンドの Step 2 にリスクレベル判定（Step 2a）とリスクレベル別レビュアー構成（Step 2b）を追加する。HIGH: middleware.ts, prisma/schema.prisma, 新規 API, terraform/, .env 変更 → 全レビュアー + spec-compliance-reviewer。MEDIUM: 上記以外の一般的な変更 → 既存ドメイン検出ルール通り。LOW: .css/.md/.test.ts のみ → security-sentinel + type-safety-reviewer のみ。変更ファイルに HIGH と LOW が混在する場合は最も高いレベル（HIGH）を採用する。
  - **私の解釈**: 既存の Step 2（動的レビュアー選択）を拡張し、Step 2a（リスクレベル判定）と Step 2b（リスクレベル別レビュアー構成）を追加する。Step 2a では `git diff --stat` の出力をもとにリスクレベルを判定し、Step 2b でそのリスクレベルに応じたレビュアー構成を決定する。MEDIUM の場合は既存の動的レビュアー選択ロジックをそのまま使う。
  - **前提（仕様に未記載だが私が仮定すること）**: 既存の Step 2 の動的レビュアー選択テーブルは MEDIUM リスクの場合のルールとして維持する。Step 2a/2b は Step 2 内のサブステップとして追加する（Step 2 を分割するのではなく拡張する）。リスクレベルは REVIEW CONTEXT に含める。
  - **仕様でカバーされないエッジケース**: 「新規 API」の判定基準。対応: git diff --stat で新規ファイルとして src/app/api/ 配下が表示されていればHIGH判定とする。

## 実装判断

| 判断項目 | 選択肢 | 採用 | 根拠 | 却下理由 |
|---|---|---|---|---|
| Step 2 の構成 | A: Step 2a/2b を Step 2 内のサブステップとして追加, B: Step 2 を完全に置き換え | A | 仕様に「Step 2 にリスクレベル判定（Step 2a）を追加」と記載。MEDIUM は既存ルール通りなので既存テーブルを維持する必要がある | B: MEDIUM 時の既存ルールが失われる |
| リスクレベルの判定順 | A: HIGH → LOW → MEDIUM（デフォルト）, B: LOW → HIGH → MEDIUM | A | HIGH の条件に該当するかを先にチェックし、次に LOW のみかをチェックし、どちらでもなければ MEDIUM とする方が自然 | B: 判定順序が不自然。混在時に最高レベルを採用するルールとの整合性が悪い |

## 必須チェック項目
- [x] 入力の有効値/無効値は何か？ → git diff --stat の出力。変更ファイルなしの場合は LOW として扱う
- [x] エラー時の振る舞いは？ → 該当なし（リスク判定は git diff --stat 出力のパターンマッチ）
- [x] 外部依存が失敗した場合は？ → 該当なし
- [x] 非同期処理の場合、競合状態への対処は？ → 該当なし

## ギャップ検出（エスカレーション候補）
- なし

---

## Phase B: 実装完了後の追記

### 変更ファイル一覧

#### 作成したファイル
- なし

#### 修正したファイル
- `~/.claude/commands/review.md`: Step 2 を拡張し、Step 2a（リスクレベル判定テーブル）と Step 2b（リスクレベル別レビュアー構成）を追加。REVIEW CONTEXT テンプレートにリスクレベルフィールドを追加。既存の動的レビュアー選択テーブルは MEDIUM 時のルールとして維持。

#### 削除したファイル
- なし

### 実装の振り返り
- 仕様の曖昧性への対処: 「新規 API」の判定基準が仕様にやや曖昧だったため、`src/app/api/` 配下の新規ファイル追加として定義した。
- 却下した代替案: Step 2 を完全に置き換える案を却下。MEDIUM 時には既存のドメイン検出ルールをそのまま使用する必要があるため、Step 2a/2b をサブステップとして追加する方式を採用した。
- 想定外の発見: REVIEW CONTEXT テンプレートは Step 1 で定義されているが、リスクレベルは Step 2a で判定される。テンプレート内の記述としてはプレースホルダとして配置し、実行時に Step 2a の結果を注入する形にした。
