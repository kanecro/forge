# Spec Interpretation: Task 3-4 /compound に Three Strikes Rule + Shift-Left フィードバック分類を追加

## 対象要件
- Requirement: REQ-014 `/compound` の Three Strikes Rule + Shift-Left 分類
  - **仕様の記述**:
    - GIVEN 同一種別の学びが `docs/compound/` に3回蓄積される WHEN 閾値ルールを適用する THEN 必ずプロセス改善を提案する。問題の根本原因を分析し、前段フェーズでの防止策を含める
    - GIVEN /review で発見された問題を分類する WHEN Shift-Left 分類を実行する THEN 設計で防げた→spec-validator追加提案、実装で防げた→ドメインSkill更新提案、テストで防げた→テストSkill更新提案
    - GIVEN 問題が複数のカテゴリに該当する WHEN Shift-Left分類を行う THEN 最も早いフェーズを優先
  - **私の解釈**:
    - 既存の閾値ルール（3段階: 重大/中程度/軽微）を4段階に拡張し、「3回ルール」を「中程度」と「軽微」の間に挿入する（重大→3回ルール→中程度→軽微の順序ではなく、仕様 REQ-M03 に従い「重大→3回ルール→中程度→軽微」の4段階）
    - Shift-Left フィードバック分類は Learning Router セクション内に新しいサブセクションとして追加する
    - 分類の判断基準を明確に定義する
  - **前提（仕様に未記載だが私が仮定すること）**:
    - 3回ルールは「同一種別」の学びを `docs/compound/` 内で Grep してカウントする既存の中程度ルール（2回以上）を包含・拡張するものとする
    - REQ-M03 では「4段階（重大、3回ルール、中程度、軽微）」と明記されているので、この順序で定義する
  - **仕様でカバーされないエッジケース**:
    - 3回ルールと中程度（2回）の関係: 2回目は「中程度」として更新提案、3回目は「3回ルール」としてプロセス改善提案。異なる性質のアクションなので両方独立に機能する

- Requirement: REQ-M03 `/compound` の閾値ルール拡張
  - **仕様の記述**: GIVEN 閾値ルールを検証する WHEN 段階数を確認する THEN 4段階（重大、3回ルール、中程度、軽微）が定義されている
  - **私の解釈**: 現在の「3段階」の見出しを「4段階」に変更し、Three Strikes Rule を追加する
  - **前提**: 順序は重大→3回ルール→中程度→軽微。「3回ルール」は中程度の上位に位置する
  - **仕様でカバーされないエッジケース**: なし

## 実装判断

| 判断項目 | 選択肢 | 採用 | 根拠 | 却下理由 |
|---|---|---|---|---|
| Three Strikes の配置位置 | A: 閾値テーブル内に行追加, B: 別セクション | A | REQ-M03 が4段階テーブルを明確に指定 | B: 仕様と矛盾 |
| Shift-Left の配置位置 | A: Learning Router 内サブセクション, B: 新しいトップレベルセクション | A | タスク説明に「Learning Router に Shift-Left フィードバック分類を追加」と明記 | B: 既存構造から外れる |
| 3回ルールの閾値順序 | A: 重大→3回→中程度→軽微, B: 重大→中程度→3回→軽微 | A | REQ-M03 が「重大、3回ルール、中程度、軽微」の順序を明記 | B: 仕様と矛盾 |

## 必須チェック項目
- [x] 入力の有効値/無効値は何か？ → 学びの種別（分類テーブルの種別）でカウントする。無効値は特にない
- [x] エラー時の振る舞いは？ → エラーシナリオなし（マークダウン定義のため）
- [x] 外部依存が失敗した場合は？ → 該当なし
- [x] 非同期処理の場合、競合状態への対処は？ → 該当なし

## ギャップ検出（エスカレーション候補）
- なし

---

## Phase B: 実装完了後の追記

### 変更ファイル一覧

#### 作成したファイル
- なし

#### 修正したファイル
- `~/.claude/commands/compound.md`: 閾値ルールを3段階から4段階に拡張（Three Strikes Rule追加）、Shift-Leftフィードバック分類セクション追加、ルーティング手順にShift-Left分類ステップと3回ルール判定を追加

#### 削除したファイル
- なし

### 実装の振り返り
- 仕様の曖昧性への対処: REQ-M03 が「重大、3回ルール、中程度、軽微」の順序を明記していたため迷いなく配置
- 却下した代替案: Shift-Leftを独立セクションにする案→Learning Router内に配置する方がルーティング手順との連携が自然
- 想定外の発見: 特になし
