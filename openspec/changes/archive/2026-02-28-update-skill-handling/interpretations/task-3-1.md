# Spec Interpretation: Task 3-1 spec-validator に Last Responsible Moment チェックを追加

## 対象要件
- Requirement: REQ-011 spec-validator の Last Responsible Moment チェック
  - **仕様の記述**:
    - GIVEN 仕様に含まれる各設計判断を分類する WHEN Type 1/Type 2 を判定する THEN Type 1（不可逆: データモデル、主要 API 契約、認証方式）は今確定すべきと判断し、Type 2（可逆: 内部実装詳細、ライブラリ選定、キャッシュ戦略）は実装に委譲可能と判断する
    - GIVEN 仕様に Type 2 判断の詳細が含まれる WHEN 検証結果を出力する THEN 「この判断は実装段階に委譲すべきでは？」と指摘し、インターフェース/抽象化レベルの仕様記述を推奨する
  - **私の解釈**: 検証項目9「Last Responsible Moment」を追加する。Type 1/Type 2 の分類基準を具体例付きで記述し、Type 2 の過度な詳細化をフラグする仕組みを定義する
  - **前提（仕様に未記載だが私が仮定すること）**:
    - LRM チェックは全要件に適用される（セキュリティ関連に限定されない）
    - Type 1/Type 2 の判定は目安であり、厳密な分類ではない。判断に迷う場合は「要確認」としてフラグする
  - **仕様でカバーされないエッジケース**:
    - Type 1 と Type 2 の境界にある判断（例: ORM の選択は Type 2 だが、ORM を使うかどうかは Type 1 に近い）: 判断の影響範囲で決める。変更コストが高いものは Type 1 寄りとする

## 実装判断

| 判断項目 | 選択肢 | 採用 | 根拠 | 却下理由 |
|---|---|---|---|---|
| 検証項目番号 | A: 9（STRIDE の次）, B: 8（STRIDE と入れ替え） | A | タスク依存関係で Task 2-3（STRIDE = 項目8）が先。LRM は項目9 として追加 | B: 既に実装済みの STRIDE の番号を変更する必要がある |
| Type 1/Type 2 の具体例 | A: delta-spec の例のみ, B: 追加の具体例付き | B | 判定の目安を具体例付きで記述することでバリデーターの判断精度を上げる。タスク記述にも「具体例付きで記述」と指定 | A: 抽象的な説明のみでは判断が曖昧になる |

## 必須チェック項目
- [x] 入力の有効値/無効値は何か？ → 検証対象は delta-spec の設計判断。全要件に適用
- [x] エラー時の振る舞いは？ → 該当なし（マークダウンファイルの編集のみ）
- [x] 外部依存が失敗した場合は？ → 該当なし
- [x] 非同期処理の場合、競合状態への対処は？ → 該当なし

## ギャップ検出（エスカレーション候補）
- なし（仕様が十分に明確）

---

## Phase B: 実装完了後の追記

### 変更ファイル一覧

#### 作成したファイル
- なし

#### 修正したファイル
- `~/.claude/agents/spec/spec-validator.md`: 検証項目9「Last Responsible Moment（LRM）チェック」を追加。Type 1（不可逆）/ Type 2（可逆）の分類基準を具体例付きで記述。判定の目安（変更の影響範囲）を追加。検証項目数を「8つ」→「9つ」に更新（セクションタイトル、ワークフロー Step 3）
- `~/.claude/commands/spec.md`: Phase 3 の検証項目参照を「8つ」→「9つ」に更新し、Last Responsible Moment を項目リストに追加

#### 削除したファイル
- なし

### 実装の振り返り
- 仕様の曖昧性への対処: Type 1/Type 2 の境界にある判断（例: ORM 選択）について、仕様が具体例を限定的にしか提供していなかったため、「判定の目安」セクションを追加して判断基準を補完した
- 却下した代替案: LRM を品質基準テーブル内に統合する案を却下。STRIDE と同様に検証項目として独立させる方が、品質基準（全要件に一律適用）と検証項目（要件の性質に応じて適用）の区別が明確
- 想定外の発見: spec.md にも検証項目数への参照があったため、Task #7 での8つ更新に続いて9つへの更新が必要だった
